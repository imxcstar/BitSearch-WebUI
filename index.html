<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-key="pageTitle">磁力搜索</title>
    <style>
        /* --- General & Theming --- */
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --muted-text-color: #6c757d;
            --primary-color: #007bff;
            --primary-hover-color: #0056b3;
            --secondary-color: #6c757d;
            --secondary-hover-color: #5a6268;
            --card-bg-color: #ffffff;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --type-tag-movie: #007bff;
            --type-tag-tv: #17a2b8;
            --type-tag-music: #fd7e14;
            --type-tag-game: #28a745;
            --type-tag-software: #6f42c1;
            --type-tag-ebook: #20c997;
            --type-tag-other: #6c757d;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 1rem;
        }

        /* --- Layout & Search Form --- */
        .container { max-width: 900px; margin: 0 auto; width: 100%; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .title { font-size: 2rem; font-weight: 600; color: var(--primary-color); margin: 0; }
        .header-controls { display: flex; align-items: center; gap: 1rem; }
        .lang-switcher button { background: none; border: none; cursor: pointer; color: var(--text-color); padding: 0.5rem; border-radius: 4px; font-weight: 500; }
        .lang-switcher button.active { color: var(--primary-color); font-weight: 700; text-decoration: underline; }
        #settings-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; }

        .search-form { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 2rem; }
        #search-input { flex: 1 1 300px; padding: 0.75rem 1rem; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 6px; }
        #search-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }

        #content-type-filter { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 1rem center; padding: 0.75rem 2.5rem 0.75rem 1rem; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: white; flex: 0 1 auto; }
        #search-button { padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600; background-color: var(--primary-color); color: #fff; border: none; border-radius: 6px; cursor: pointer; flex: 0 1 auto; }
        #search-button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #search-button:hover:not(:disabled) { background-color: var(--primary-hover-color); }

        /* --- Results Area --- */
        #results-container { display: flex; flex-direction: column; gap: 1.5rem; }
        .result-item { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 2px 8px var(--shadow-color); overflow: hidden; }
        .result-main-content { display: flex; padding: 1rem; gap: 1rem; }
        .result-poster { width: 120px; height: 180px; flex-shrink: 0; background-color: #e9ecef; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .result-poster img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .poster-placeholder-icon { width: 50%; height: 50%; color: var(--muted-text-color); }
        .result-details { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; }
        .result-title { font-size: 1.2rem; font-weight: 600; margin: 0 0 0.5rem 0; }
        .result-meta { display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; font-size: 0.85rem; color: var(--muted-text-color); margin-bottom: 0.75rem; align-items: center; }
        .meta-tag { background-color: #e9ecef; padding: 0.2rem 0.5rem; border-radius: 1rem; color: var(--text-color); font-weight: 500; }
        .type-tag { color: white; padding: 0.25rem 0.6rem; }
        .type-tag-movie { background-color: var(--type-tag-movie); }
        .type-tag-tv_show { background-color: var(--type-tag-tv); }
        .type-tag-music { background-color: var(--type-tag-music); }
        .type-tag-game { background-color: var(--type-tag-game); }
        .type-tag-software { background-color: var(--type-tag-software); }
        .type-tag-ebook { background-color: var(--type-tag-ebook); }
        .type-tag-comic { background-color: var(--type-tag-ebook); }
        .type-tag-audiobook { background-color: var(--type-tag-music); }
        .type-tag-xxx { background-color: #dc3545; }
        .type-tag-other { background-color: var(--type-tag-other); }

        .result-external-links a { text-decoration: none; background-color: #f1f3f5; }
        .result-external-links a:hover { background-color: #e9ecef; text-decoration: underline; }

        .result-overview { font-size: 0.9rem; line-height: 1.5; color: var(--muted-text-color); margin-bottom: 1rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .result-actions { display: flex; gap: 0.5rem; margin-top: auto; }
        .action-btn { border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: background-color 0.2s; }
        .copy-btn { background-color: #28a745; color: white; }
        .copy-btn:hover { background-color: #218838; }
        .toggle-files-btn { background-color: var(--secondary-color); color: white; }
        .toggle-files-btn:hover { background-color: var(--secondary-hover-color); }
        
        /* Expanded File List */
        .file-list-container { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out, padding 0.5s ease-out; background-color: #f8f9fa; font-size: 0.9rem; padding: 0 1rem; }
        .result-item.expanded .file-list-container { max-height: 500px; overflow-y: auto; padding: 1rem; border-top: 1px solid var(--border-color); }
        .file-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.5rem; }
        .file-item { display: flex; justify-content: space-between; padding: 0.25rem 0.5rem; border-radius: 4px; }
        .file-item:nth-child(odd) { background-color: #e9ecef; }
        .file-path { word-break: break-all; padding-right: 1rem; }
        .file-size { flex-shrink: 0; font-weight: 500; color: var(--muted-text-color); }

        /* --- Settings Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: var(--card-bg-color); padding: 2rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; }
        .modal-content h2 { margin-top: 0; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input { width: 100%; box-sizing: border-box; padding: 0.75rem 1rem; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 6px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }

        /* --- Translate Toggle --- */
        #translate-toggle-container { display: flex; align-items: center; gap: 0.5rem; }
        #translate-toggle-container svg { fill: var(--muted-text-color); }
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(14px); }
        .slider.round { border-radius: 20px; }
        .slider.round:before { border-radius: 50%; }
        [data-translatable] { transition: opacity 0.3s ease-in-out; }

        /* Other Styles */
        .status-message { text-align: center; color: var(--muted-text-color); font-size: 1.1rem; padding: 3rem 0; }
        #pagination-container { display: flex; justify-content: center; align-items: center; margin-top: 2rem; gap: 1rem; }
        .pagination-btn { padding: 0.5rem 1rem; border: 1px solid var(--border-color); background-color: var(--card-bg-color); border-radius: 5px; cursor: pointer; }
        .pagination-btn:hover:not(:disabled) { background-color: var(--bg-color); }
        .pagination-btn:disabled { color: #adb5bd; cursor: not-allowed; }
        #page-info { font-weight: 500; }
        #toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background-color: #343a40; color: #fff; padding: 0.75rem 1.5rem; border-radius: 2rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #toast.show { opacity: 1; visibility: visible; }
        
        /* --- Mobile Responsive Layout --- */
        @media (max-width: 600px) {
            body {
                padding: 0.75rem;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header-controls {
                width: 100%;
                justify-content: flex-end; /* 保持控制按钮在右侧 */
            }
            
            .title {
                font-size: 1.75rem;
            }

            /* 当过滤器和按钮换行时，让它们充满整行 */
            #content-type-filter, #search-button {
                flex-grow: 1;
            }

            /* 搜索结果卡片样式 */
            .result-main-content {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .result-poster {
                width: 160px;
                height: auto;
                aspect-ratio: 2/3; /* 保持封面比例 */
                margin: 0;
            }
            
            .result-details {
                align-items: center; /* 居中详情内容 */
                width: 100%;
            }

            .result-meta, .result-actions {
                justify-content: center; /* 居中元信息和按钮 */
                width: 100%;
            }
            
            .result-overview {
                -webkit-line-clamp: 4; /* 多显示一行简介 */
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1 class="title" data-i18n-key="pageTitle">磁力搜索</h1>
            <div class="header-controls">
                <div class="lang-switcher">
                    <button id="lang-en">English</button>
                    <span>/</span>
                    <button id="lang-zh" class="active">中文</button>
                </div>
                <div id="translate-toggle-container" data-i18n-title="translateTitle">
                    <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 0 24 24" width="22px"><path d="M0 0h24v24H0z" fill="none"/><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4.86 19l5.09-5.02.03.03 5.02 5.02L17 17.11l-5.02-5.02.03-.03z"/></svg>
                    <label class="switch">
                        <input type="checkbox" id="translate-toggle">
                        <span class="slider round"></span>
                    </label>
                </div>
                <button id="settings-btn" title="Settings">⚙️</button>
            </div>
        </header>

        <main>
            <form class="search-form" id="search-form">
                <input type="search" id="search-input" data-i18n-placeholder="searchPlaceholder" required>
                <select id="content-type-filter"></select>
                <button type="submit" id="search-button" data-i18n-key="searchButton">搜索</button>
            </form>

            <section id="results-container">
                </section>

            <nav id="pagination-container" style="display: none;">
                <button id="prev-btn" class="pagination-btn" data-i18n-key="prevButton">上一页</button>
                <span id="page-info"></span>
                <button id="next-btn" class="pagination-btn" data-i18n-key="nextButton">下一页</button>
            </nav>
        </main>
    </div>

    <div id="settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 data-i18n-key="settingsTitle">Settings</h2>
            <div class="form-group">
                <label for="api-endpoint-input" data-i18n-key="apiEndpointLabel">API Endpoint URL</label>
                <input type="url" id="api-endpoint-input" placeholder="http://localhost:3333/graphql">
            </div>
            <div class="modal-actions">
                <button id="save-settings-btn" class="action-btn copy-btn" data-i18n-key="saveButton">Save</button>
                <button id="close-settings-btn" class="action-btn toggle-files-btn">Close</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIGURATION ---
            let API_ENDPOINT = ''; 
            const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500'; 
            const RESULTS_PER_PAGE = 10;
            const CONTENT_TYPES = ["movie", "tv_show", "music", "ebook", "comic", "audiobook", "game", "software", "xxx"];

            // --- STATE & DOM ---
            let currentPage = 1, currentQuery = '', totalResults = 0, isLoading = false;
            let currentRenderedItems = [];
            let isAutoTranslateEnabled = false;
            const doc = (id) => document.getElementById(id);
            const searchForm = doc('search-form'), searchInput = doc('search-input'), searchButton = doc('search-button'),
                  resultsContainer = doc('results-container'), paginationContainer = doc('pagination-container'),
                  prevBtn = doc('prev-btn'), nextBtn = doc('next-btn'), pageInfo = doc('page-info'),
                  toast = doc('toast'), langEnBtn = doc('lang-en'), langZhBtn = doc('lang-zh'),
                  settingsBtn = doc('settings-btn'), settingsModal = doc('settings-modal'),
                  apiEndpointInput = doc('api-endpoint-input'), saveSettingsBtn = doc('save-settings-btn'),
                  closeSettingsBtn = doc('close-settings-btn'), contentTypeFilter = doc('content-type-filter'),
                  translateToggle = doc('translate-toggle');

            // --- I18N & TRANSLATIONS ---
            const translations = {
                en: {
                    pageTitle: "Magnet Search", searchPlaceholder: "Search...", searchButton: "Search",
                    initialMessage: "Enter a search term to begin.", loadingMessage: "Searching...",
                    noResultsMessage: "No results found.", errorMessage: "An error occurred.",
                    prevButton: "Previous", nextButton: "Next", pageLabel: "Page", ofLabel: "of",
                    copyButton: "Copy Magnet", copiedMessage: "Copied!", showFilesButton: "Show Files",
                    hideFilesButton: "Hide Files", loadingFiles: "Loading file list...", noFilesFound: "No files found.",
                    sizeLabel: "Size", resolutionLabel: "Resolution", filesCountLabel: "Files", publishedLabel: "Published",
                    noOverview: "No overview available.",
                    settingsTitle: "Settings", apiEndpointLabel: "API Endpoint URL", saveButton: "Save",
                    endpointSaved: "API Endpoint saved!", endpointEmpty: "API Endpoint cannot be empty.",
                    allTypes: "All Types", externalLinksLabel: "Links",
                    translateTitle: "Translate search results (title and overview)",
                    movie: "Movie", tv_show: "TV Show", music: "Music", ebook: "E-book",
                    comic: "Comic", audiobook: "Audiobook", game: "Game", software: "Software",
                    xxx: "XXX", other: "Other"
                },
                zh: {
                    pageTitle: "磁力搜索", searchPlaceholder: "搜索...", searchButton: "搜索",
                    initialMessage: "请输入关键词开始搜索。", loadingMessage: "正在搜索中...",
                    noResultsMessage: "未找到结果。", errorMessage: "发生错误。",
                    prevButton: "上一页", nextButton: "下一页", pageLabel: "第", ofLabel: "页，共",
                    copyButton: "复制磁链", copiedMessage: "已复制！", showFilesButton: "文件列表",
                    hideFilesButton: "收起列表", loadingFiles: "正在加载文件列表...", noFilesFound: "无文件信息。",
                    sizeLabel: "大小", resolutionLabel: "分辨率", filesCountLabel: "文件数", publishedLabel: "发布于",
                    noOverview: "暂无简介。",
                    settingsTitle: "设置", apiEndpointLabel: "API 端点网址", saveButton: "保存",
                    endpointSaved: "API 端点已保存！", endpointEmpty: "API 端点不能为空。",
                    allTypes: "所有类型", externalLinksLabel: "外部链接",
                    translateTitle: "翻译搜索结果（标题和简介）",
                    movie: "电影", tv_show: "电视剧", music: "音乐", ebook: "电子书",
                    comic: "漫画", audiobook: "有声读物", game: "游戏", software: "软件",
                    xxx: "XXX", other: "其他"
                }
            };

            // --- GRAPHQL QUERIES ---
            const GQL_SEARCH_QUERY = `
                query TorrentContentSearch($input: TorrentContentSearchQueryInput!) {
                    torrentContent {
                        search(input: $input) {
                            totalCount
                            items {
                                infoHash
                                title
                                contentType
                                videoResolution
                                publishedAt
                                content {
                                    overview
                                    attributes { key, value }
                                    externalLinks { url, metadataSource { name } }
                                }
                                torrent { size, magnetUri, filesCount, name, singleFile }
                            }
                        }
                    }
                }
            `;
            const GQL_FILES_QUERY = `
                query TorrentFiles($input: TorrentFilesQueryInput!) {
                    torrent {
                        files(input: $input) {
                            items { path, size }
                        }
                    }
                }
            `;

            // --- API & LOGIC ---
            const callApi = async (query, variables) => {
                if (!API_ENDPOINT) throw new Error('API_ENDPOINT_NOT_CONFIGURED');
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, variables })
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.errors) {
                    console.error('GraphQL Errors:', result.errors);
                    throw new Error('GraphQL query returned errors.');
                }
                return result.data;
            };

            const performSearch = async (query, page = 1) => {
                if (isLoading) return;
                isLoading = true;
                searchButton.disabled = true;
                resultsContainer.innerHTML = `<p class="status-message">${translations[getLang()].loadingMessage}</p>`;
                paginationContainer.style.display = 'none';
                
                currentQuery = query;
                currentPage = page;

                try {
                    const searchInputVars = {
                        queryString: query, limit: RESULTS_PER_PAGE, offset: (page - 1) * RESULTS_PER_PAGE,
                        totalCount: true, orderBy: [{ field: "relevance", descending: true }]
                    };
                    const selectedContentType = contentTypeFilter.value;
                    if (selectedContentType) {
                        searchInputVars.facets = { contentType: { filter: [selectedContentType] } };
                    }
                    
                    const data = await callApi(GQL_SEARCH_QUERY, { input: searchInputVars });
                    const searchResult = data.torrentContent.search;
                    totalResults = searchResult.totalCount;
                    currentRenderedItems = searchResult.items;
                    renderResults(currentRenderedItems);
                    updatePaginationControls();
                    updateUrlHistory(false); // Do not add a new state, just replace
                } catch (error) {
                    console.error('Search failed:', error);
                    let msg = (error.message === 'API_ENDPOINT_NOT_CONFIGURED') 
                        ? '⚠️ Please set a valid API_ENDPOINT in Settings.' 
                        : translations[getLang()].errorMessage;
                    resultsContainer.innerHTML = `<p class="status-message">${msg}</p>`;
                } finally {
                    isLoading = false;
                    searchButton.disabled = false;
                }
            };
            
            const fetchAndRenderFiles = async (infoHash, container, button) => {
                const t = translations[getLang()];
                container.innerHTML = `<p style="padding: 1rem 0; text-align: center;">${t.loadingFiles}</p>`;
                try {
                     const data = await callApi(GQL_FILES_QUERY, { input: { infoHashes: [infoHash], limit: 500 } });
                    const files = data.torrent.files.items;
                    container.innerHTML = '';
                    if (!files || files.length === 0) {
                        container.innerHTML = `<p style="text-align: center;">${t.noFilesFound}</p>`;
                        return;
                    }
                    const ul = document.createElement('ul');
                    ul.className = 'file-list';
                    files.forEach(file => {
                        const li = document.createElement('li');
                        li.className = 'file-item';
                        li.innerHTML = `<span class="file-path">${file.path}</span><span class="file-size">${formatBytes(file.size)}</span>`;
                        ul.appendChild(li);
                    });
                    container.appendChild(ul);
                    button.dataset.loaded = 'true';
                } catch(error) {
                    console.error('Failed to fetch files:', error);
                    container.innerHTML = `<p>${t.errorMessage}</p>`;
                }
            };

            const googleTranslate = async (text, targetLang) => {
                if (!text || !text.trim()) return text;
                const toLang = targetLang === 'zh' ? 'zh-CN' : targetLang;
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${toLang}&dt=t&q=${encodeURIComponent(text)}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.warn(`Translation API failed with status: ${response.status}`);
                        return text;
                    }
                    const data = await response.json();
                    if (data && data[0]) {
                        return data[0].map(segment => segment[0]).join('') || text;
                    }
                    return text;
                } catch (error) {
                    console.error("Google Translate request failed:", error);
                    return text;
                }
            };

            const applyTranslations = () => {
                const targetLang = getLang();
                const translatableElements = resultsContainer.querySelectorAll('[data-translatable]');

                translatableElements.forEach(async el => {
                    const infoHash = el.dataset.infohash;
                    const type = el.dataset.translatable;
                    const originalItem = currentRenderedItems.find(i => i.infoHash === infoHash);
                    const t = translations[targetLang];
                    
                    if (!originalItem) return;

                    const originalText = type === 'title' ? originalItem.title : (originalItem.content?.overview || t.noOverview);
                    if (!originalText || originalText === t.noOverview) return;

                    el.style.opacity = '0.5';
                    const translatedText = await googleTranslate(originalText, targetLang);
                    
                    if (resultsContainer.contains(el)) {
                         el.textContent = translatedText;
                         el.style.opacity = '1';
                    }
                });
            };

            // --- UTILITY & RENDERING FUNCTIONS ---
            const getLang = () => document.documentElement.lang;
            const formatBytes = (bytes, decimals = 2) => {
                if (!bytes || bytes === 0) return '0 Bytes';
                const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            };
            const showToast = (message) => {
                toast.textContent = message; toast.classList.add('show');
                setTimeout(() => { toast.classList.remove('show'); }, 2000);
            };
            const findPosterPath = (attributes) => {
                if (!attributes) return null;
                const posterAttr = attributes.find(attr => attr.key === 'poster_path');
                return posterAttr ? posterAttr.value : null;
            };
            const getPlaceholderIcon = (contentType) => {
                const icons = {
                    movie: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"></path></svg>`,
                    tv_show: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"></path></svg>`,
                    music: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55c-2.21 0-4 1.79-4 4s1.79 4 4 4s4-1.79 4-4V7h4V3h-6z"></path></svg>`,
                    game: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.58 16.09l-1.17-1.17c.1-.28.19-.58.19-.89s-.09-.61-.19-.89l1.17-1.17c.47-.47.63-1.15.42-1.76l-1.5-2.6c-.2-.36-.6-.56-1-.56s-.8.2-1 .56l-1.17 1.17c-.32-.17-.65-.3-.99-.4l-.2-1.34C15.93 6.35 15.5 6 15 6s-.93.35-1.07.85l-.2 1.34c-.34.1-.67.23-.99.4L11.57 7.4c-.47-.47-1.15-.63-1.76-.42l-2.6 1.5c-.36.2-.56.6-.56 1s.2.8.56 1l1.17 1.17c-.1.28-.19.58-.19.89s.09.61.19.89L6.4 17.27c-.47.47-.63 1.15-.42 1.76l1.5 2.6c.2.36.6.56 1 .56s.8-.2 1-.56l1.17-1.17c.32.17.65.3.99.4l.2 1.34c.14.5.57.85 1.07.85s.93-.35 1.07-.85l.2-1.34c.34-.1.67-.23-.99-.4l1.17 1.17c.47.47 1.15.63 1.76.42l2.6-1.5c.36-.2.56-.6.56-1s-.2-.8-.56-1zM12 15c-1.66 0-3-1.34-3-3s1.34-3 3-3s3 1.34 3 3s-1.34 3-3 3z"></path></svg>`,
                    software: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6l6 6l1.4-1.4zm5.2 0l4.6-4.6l-4.6-4.6L16 6l6 6l-6 6l-1.4-1.4z"></path></svg>`,
                    ebook: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5c-1.95 0-4.05.4-5.5 1.5c-1.45-1.1-3.55-1.5-5.5-1.5C5.33 4.5 4.11 4.65 3 5V19c1.11.35 2.33.5 3.5.5c1.95 0 4.05-.4 5.5-1.5c1.45 1.1 3.55 1.5 5.5 1.5c1.17 0 2.39-.15 3.5-.5V5zM21 17.5c-1.11.35-2.33.5-3.5.5c-1.95 0-4.05-.4-5.5-1.5V7.5c1.45-1.1 3.55-1.5 5.5-1.5c1.17 0 2.39.15 3.5.5v10z"></path></svg>`,
                    other: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"></path></svg>`
                };
                return `<div class="poster-placeholder-icon">${icons[contentType] || icons['other']}</div>`;
            };

            const renderResults = (items) => {
                resultsContainer.innerHTML = '';
                const t = translations[getLang()];
                if (!items || items.length === 0) {
                    if (currentQuery) { // Only show 'no results' if a search was actually made
                        resultsContainer.innerHTML = `<p class="status-message">${t.noResultsMessage}</p>`;
                    }
                    return;
                }

                const itemElements = items.map(item => {
                    const posterPath = findPosterPath(item.content?.attributes);
                    const posterContent = posterPath ? `<img src="${IMAGE_BASE_URL}${posterPath}" alt="Poster" loading="lazy">` : getPlaceholderIcon(item.contentType);
                    
                    const type = item.contentType || 'other';
                    const typeClass = `type-tag-${type.toLowerCase().replace(' ', '_')}`;
                    const typeText = t[type] || t['other'];
                    const publishedDate = new Date(item.publishedAt).toLocaleDateString();

                    const externalLinks = item.content?.externalLinks || [];
                    let externalLinksHtml = '';
                    if (externalLinks.length > 0) {
                        externalLinksHtml = `<div class="result-meta result-external-links">
                            ${externalLinks.map(link => `<a href="${link.url}" target="_blank" rel="noopener noreferrer" class="meta-tag">${link.metadataSource.name}</a>`).join('')}
                        </div>`;
                    }

                    const el = document.createElement('div');
                    el.className = 'result-item';
                    el.innerHTML = `
                        <div class="result-main-content">
                            <div class="result-poster">${posterContent}</div>
                            <div class="result-details">
                                <h3 class="result-title" data-translatable="title" data-infohash="${item.infoHash}">${item.title}</h3>
                                <div class="result-meta">
                                    <span class="meta-tag type-tag ${typeClass}">${typeText}</span>
                                    ${item.videoResolution ? `<span class="meta-tag">${item.videoResolution.replace('V','')}</span>` : ''}
                                    <span>${t.filesCountLabel}: <strong>${item.torrent.filesCount || 1}</strong></span>
                                    <span>${t.sizeLabel}: <strong>${formatBytes(item.torrent.size)}</strong></span>
                                </div>
                                <div class="result-meta">
                                     <span>${t.publishedLabel}: <strong>${publishedDate}</strong></span>
                                </div>
                                ${externalLinksHtml}
                                <p class="result-overview" data-translatable="overview" data-infohash="${item.infoHash}">${item.content?.overview || t.noOverview}</p>
                                <div class="result-actions">
                                    <button class="action-btn copy-btn" data-magnet="${item.torrent.magnetUri}">${t.copyButton}</button>
                                    <button class="action-btn toggle-files-btn" data-infohash="${item.infoHash}">${t.showFilesButton}</button>
                                </div>
                            </div>
                        </div>
                        <div class="file-list-container"></div>
                    `;
                    return el;
                });

                resultsContainer.append(...itemElements);

                if (isAutoTranslateEnabled) {
                    applyTranslations();
                }
            };
            
            const updatePaginationControls = () => {
                if (totalResults <= RESULTS_PER_PAGE) {
                    paginationContainer.style.display = 'none'; return;
                }
                const totalPages = Math.ceil(totalResults / RESULTS_PER_PAGE);
                paginationContainer.style.display = 'flex';
                const t = translations[getLang()];
                pageInfo.textContent = getLang() === 'zh' ? `${t.pageLabel} ${currentPage} ${t.ofLabel} ${totalPages} 页` : `${t.pageLabel} ${currentPage} ${t.ofLabel} ${totalPages}`;
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage >= totalPages;
            };

            const populateContentTypeFilter = () => {
                const t = translations[getLang()];
                const currentVal = contentTypeFilter.value;
                contentTypeFilter.innerHTML = `<option value="">${t.allTypes}</option>`;
                CONTENT_TYPES.forEach(type => {
                    const typeKey = type.toLowerCase().replace(' ', '_');
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = t[typeKey] || type;
                    contentTypeFilter.appendChild(option);
                });
                contentTypeFilter.value = currentVal;
            };

            const setLanguage = (lang, shouldRerender = true) => {
                localStorage.setItem('searchLang', lang);
                document.documentElement.lang = lang;
                const t = translations[lang];
                document.querySelectorAll('[data-i18n-key]').forEach(el => { if (t[el.dataset.i18nKey]) el.textContent = t[el.dataset.i18nKey]; });
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { if (t[el.dataset.i18nPlaceholder]) el.placeholder = t[el.dataset.i18nPlaceholder]; });
                document.querySelectorAll('[data-i18n-title]').forEach(el => { if (t[el.dataset.i18nTitle]) el.title = t[el.dataset.i18nTitle]; });
                
                langEnBtn.classList.toggle('active', lang === 'en');
                langZhBtn.classList.toggle('active', lang === 'zh');
                
                populateContentTypeFilter();

                if(shouldRerender) {
                    if (currentRenderedItems.length > 0) {
                        renderResults(currentRenderedItems);
                    } else if (!currentQuery) { // Re-render initial message if no search is active
                        resultsContainer.innerHTML = `<p class="status-message">${t.initialMessage}</p>`;
                    }
                    if (paginationContainer.style.display !== 'none') {
                        updatePaginationControls();
                    }
                }
            };
            
            const loadSettings = () => {
                const savedEndpoint = localStorage.getItem('apiEndpoint');
                if (savedEndpoint) {
                    API_ENDPOINT = savedEndpoint;
                }
                apiEndpointInput.value = API_ENDPOINT;

                const savedTranslateState = localStorage.getItem('autoTranslateEnabled');
                isAutoTranslateEnabled = savedTranslateState === 'true';
                translateToggle.checked = isAutoTranslateEnabled;

                const savedLang = localStorage.getItem('searchLang');
                const browserLang = navigator.language || navigator.userLanguage;
                setLanguage(savedLang || (browserLang.startsWith('zh') ? 'zh' : 'en'), false);
            };

            const updateUrlHistory = (isNewState = true) => {
                const params = new URLSearchParams();
                if (currentQuery) {
                    params.set('query', currentQuery);
                    params.set('page', currentPage);
                    const selectedContentType = contentTypeFilter.value;
                    if (selectedContentType) {
                        params.set('contentType', selectedContentType);
                    }
                }
                
                const newRelativeUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
                const state = { query: currentQuery, page: currentPage, contentType: contentTypeFilter.value };
                
                if (isNewState) {
                    history.pushState(state, '', newRelativeUrl);
                } else {
                    history.replaceState(state, '', newRelativeUrl);
                }
            };

            const handleUrlParams = () => {
                const params = new URLSearchParams(window.location.search);
                const query = params.get('query');
                const page = parseInt(params.get('page'), 10) || 1;
                const contentType = params.get('contentType');

                if (contentType) {
                    contentTypeFilter.value = contentType;
                }

                if (query) {
                    searchInput.value = query;
                    performSearch(query, page);
                } else {
                    // Show initial message if no query in URL
                    resultsContainer.innerHTML = `<p class="status-message">${translations[getLang()].initialMessage}</p>`;
                }
            };


            // --- EVENT LISTENERS ---
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = searchInput.value.trim();
                if (query) {
                    currentQuery = query;
                    currentPage = 1; // Reset to first page on new search
                    updateUrlHistory();
                    performSearch(currentQuery, currentPage);
                }
            });

            prevBtn.addEventListener('click', () => { 
                if (currentPage > 1) {
                    currentPage--;
                    updateUrlHistory();
                    performSearch(currentQuery, currentPage);
                }
            });

            nextBtn.addEventListener('click', () => { 
                if (currentPage < Math.ceil(totalResults/RESULTS_PER_PAGE)) {
                    currentPage++;
                    updateUrlHistory();
                    performSearch(currentQuery, currentPage);
                }
            });

            resultsContainer.addEventListener('click', (e) => {
                const copyBtn = e.target.closest('.copy-btn');
                const toggleBtn = e.target.closest('.toggle-files-btn');
                
                if (copyBtn) {
                    navigator.clipboard.writeText(copyBtn.dataset.magnet).then(() => showToast(translations[getLang()].copiedMessage));
                }
                
                if (toggleBtn) {
                    const resultItem = toggleBtn.closest('.result-item');
                    const fileContainer = resultItem.querySelector('.file-list-container');
                    const isExpanded = resultItem.classList.toggle('expanded');
                    const t = translations[getLang()];
                    
                    toggleBtn.textContent = isExpanded ? t.hideFilesButton : t.showFilesButton;

                    if (isExpanded && toggleBtn.dataset.loaded !== 'true') {
                        const item = currentRenderedItems.find(i => i.infoHash === toggleBtn.dataset.infohash);
                        
                        if (item && item.torrent.singleFile) {
                            fileContainer.innerHTML = `<ul class="file-list"><li class="file-item"><span class="file-path">${item.torrent.name}</span><span class="file-size">${formatBytes(item.torrent.size)}</span></li></ul>`;
                            toggleBtn.dataset.loaded = 'true';
                        } else {
                            fetchAndRenderFiles(toggleBtn.dataset.infohash, fileContainer, toggleBtn);
                        }
                    }
                }
            });

            langEnBtn.addEventListener('click', () => setLanguage('en'));
            langZhBtn.addEventListener('click', () => setLanguage('zh'));
            
            translateToggle.addEventListener('change', () => {
                isAutoTranslateEnabled = translateToggle.checked;
                localStorage.setItem('autoTranslateEnabled', String(isAutoTranslateEnabled));
                if (currentRenderedItems.length > 0) {
                    // Re-render to apply or remove translations
                    renderResults(currentRenderedItems);
                }
            });

            window.addEventListener('popstate', (e) => {
                handleUrlParams();
            });

            // Settings Modal Listeners
            settingsBtn.addEventListener('click', () => { settingsModal.style.display = 'flex'; });
            closeSettingsBtn.addEventListener('click', () => { settingsModal.style.display = 'none'; });
            settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) settingsModal.style.display = 'none'; });
            saveSettingsBtn.addEventListener('click', () => {
                const newEndpoint = apiEndpointInput.value.trim();
                const t = translations[getLang()];
                if (newEndpoint) {
                    API_ENDPOINT = newEndpoint;
                    localStorage.setItem('apiEndpoint', newEndpoint);
                    showToast(t.endpointSaved);
                    settingsModal.style.display = 'none';
                } else {
                    showToast(t.endpointEmpty);
                }
            });
            
            // --- INITIALIZATION ---
            loadSettings();
            handleUrlParams();

        });
    </script>

</body>
</html>